-- Check for null or duplicates in primary key
SELECT
	CST_ID,
	COUNT(*)
FROM
	BRONZE.CRM_CUST_INFO
GROUP BY
	CST_ID
HAVING
	COUNT(*) > 1 OR CST_ID IS NULL;

-- Check affected rows one-by-one
SELECT
	*
FROM
	BRONZE.CRM_CUST_INFO
WHERE CST_ID = 29466;

-- OR
SELECT
	*,
	ROW_NUMBER() OVER (
		PARTITION BY
			CST_ID
		ORDER BY
			CST_CREATE_DATE DESC
	) AS FLAG_LAST
FROM
	BRONZE.CRM_CUST_INFO
WHERE CST_ID = 29466;


-- Check for null or duplicates in primary key
SELECT
	*,
	ROW_NUMBER() OVER (
		PARTITION BY
			CST_ID
		ORDER BY
			CST_CREATE_DATE DESC
	) AS FLAG_LAST
FROM
	BRONZE.CRM_CUST_INFO;

SELECT * FROM 
(SELECT
	*,
	ROW_NUMBER() OVER (
		PARTITION BY
			CST_ID
		ORDER BY
			CST_CREATE_DATE DESC
	) AS FLAG_LAST
FROM
	BRONZE.CRM_CUST_INFO)t where flag_last <>1;

SELECT * FROM 
(SELECT
	*,
	ROW_NUMBER() OVER (
		PARTITION BY
			CST_ID
		ORDER BY
			CST_CREATE_DATE DESC
	) AS FLAG_LAST
FROM
	BRONZE.CRM_CUST_INFO)t where flag_last =1;

-- Check for unwanted spaces in string values
SELECT
    cst_firstname
FROM
    bronze.crm_cust_info
WHERE
    cst_firstname <> TRIM(cst_firstname);

SELECT
    cst_lastname
FROM
    bronze.crm_cust_info
WHERE
    cst_lastname <> TRIM(cst_lastname);

-- Check for null or duplicates in primary key and trim spaces in strings
-- we can say
-- select distinct cst_gender from bronze.crm_cust_info; to show the possible distinct values within the column
SELECT 
cst_id,
    cst_key,
    trim (cst_firstname) as cst_firstname,
    trim (cst_lastname) as cst_lastname,
    cst_marital_status,
    cst_gndr,
    cst_create_date
FROM 
(SELECT
	*,
	ROW_NUMBER() OVER (
		PARTITION BY
			CST_ID
		ORDER BY
			CST_CREATE_DATE DESC
	) AS FLAG_LAST
FROM
	BRONZE.CRM_CUST_INFO)t where flag_last =1;

-- DATA STANDARDIZATION & CONSISTENCY 
-- removing unwanted spaces, maps coded values to meaningful, 
-- user-friendly descriptions (i.e. data normalization & standardization)
-- handling missing values (fill in the blanks by adding a default value)
-- ensuring only one record per entity by removing duplicates (identify and retaining the most relevant rows.
--(in doing this, there may be need to increase the character-length of the target columns)
INSERT INTO
	SILVER.CRM_CUST_INFO (
		CST_ID,
		CST_KEY,
		CST_FIRSTNAME,
		CST_LASTNAME,
		CST_MARITAL_STATUS,
		CST_GNDR,
		CST_CREATE_DATE
	)
SELECT
	CST_ID,
	CST_KEY,
	TRIM(CST_FIRSTNAME) AS CST_FIRSTNAME,
	TRIM(CST_LASTNAME) AS CST_LASTNAME,
	CASE
		WHEN UPPER(TRIM(CST_MARITAL_STATUS)) = 'S' THEN 'Single'
		WHEN UPPER(TRIM(CST_MARITAL_STATUS)) = 'M' THEN 'Married'
		ELSE 'N/A'
	END AS CST_MARITAL_STATUS,
	CASE
		WHEN UPPER(TRIM(CST_GNDR)) = 'F' THEN 'female'
		WHEN UPPER(TRIM(CST_GNDR)) = 'M' THEN 'Male'
		ELSE 'N/A'
	END AS CST_GNDR,
	CST_CREATE_DATE
FROM
	(
		SELECT
			*,
			ROW_NUMBER() OVER (
				PARTITION BY
					CST_ID
				ORDER BY
					CST_CREATE_DATE DESC
			) AS FLAG_LAST
		FROM
			BRONZE.CRM_CUST_INFO
	) AS T
WHERE
	FLAG_LAST = 1;


--FOR PRODUCT INFO AND CONSIDERATION THE RELATED SOURCE DATA
	
SELECT
	PRD_ID,
	PRD_KEY,
	REPLACE (SUBSTRING(PRD_KEY, 1, 5), '-','_') AS CAT_ID,
	PRD_NM,
	PRD_COST,
	PRD_LINE,
	PRD_START_DT,
	PRD_END_DT
FROM
	BRONZE.CRM_PRD_INFO
	ORDER BY CAT_ID;

SELECT DISTINCT
	ID
FROM
	BRONZE.ERP_PX_CAT_G1V2;

SELECT
	PRD_ID,
	PRD_KEY,
	REPLACE(SUBSTRING(PRD_KEY, 1, 5), '-', '_') AS CAT_ID,
	PRD_NM,
	PRD_COST,
	PRD_LINE,
	PRD_START_DT,
	PRD_END_DT
FROM
	BRONZE.CRM_PRD_INFO
	-- to filter out unmatched data after applying transformation to join with another file bronze.erp_px_cat_g1v2
WHERE
	REPLACE(SUBSTRING(PRD_KEY, 1, 5), '-', '_') NOT IN (
		SELECT DISTINCT
			ID
		FROM
			BRONZE.ERP_PX_CAT_G1V2
	);

SELECT
	PRD_ID,
	PRD_KEY As original_prd_key,
-- Needs this to join with sales-details
	SUBSTRING(PRD_KEY from 7) as prd_key,
	PRD_NM,
	PRD_COST,
	PRD_LINE,
	PRD_START_DT,
	PRD_END_DT
FROM
	BRONZE.CRM_PRD_INFO
	-- to filter out unmatched data after applying transformation
WHERE
	SUBSTRING(PRD_KEY from 7) NOT IN (
		SELECT
			sls_prd_key
		FROM
			BRONZE.CRM_SALES_DETAILS
	);

SELECT
	PRD_ID,
	PRD_KEY As original_prd_key,
-- Needs this to join with sales-details
	SUBSTRING(PRD_KEY from 7) as prd_key,
	PRD_NM,
	PRD_COST,
	PRD_LINE,
	PRD_START_DT,
	PRD_END_DT
FROM
	BRONZE.CRM_PRD_INFO
	-- to filter out unmatched data after applying transformation
WHERE
	SUBSTRING(PRD_KEY from 7) NOT IN (
		SELECT
			sls_prd_key
		FROM
			BRONZE.CRM_SALES_DETAILS
	where sls_prd_key like 'FK-1639');

SELECT
	PRD_ID,
	PRD_KEY As original_prd_key,
-- Needs this to join with sales-details
	SUBSTRING(PRD_KEY from 7) as prd_key,
	PRD_NM,
	PRD_COST,
	PRD_LINE,
	PRD_START_DT,
	PRD_END_DT
FROM
	BRONZE.CRM_PRD_INFO
	-- to filter out unmatched data after applying transformation
WHERE
	SUBSTRING(PRD_KEY from 7) IN (
		SELECT
			sls_prd_key
		FROM
			BRONZE.CRM_SALES_DETAILS
);

-- Check for unwanted Spaces
-- Expectation: No Results
Select prd_nm
FROM bronze.crm_prd_info
WHERE prd_nm <> TRIM (prd_nm);


-- Check for Nulls or Negative Numbers
-- Expectation: No Results
Select prd_cost
FROM bronze.crm_prd_info
WHERE prd_cost < 0 or prd_cost is null;

SELECT
    prd_id,
    prd_key AS original_prd_key,
    -- Needs this to join with sales-details: substring from the 7th character to end
    SUBSTRING(prd_key FROM 7) AS prd_key,
    prd_nm,
    prd_cost,
    -- Use COALESCE in Postgres instead of ISNULL, and ensure proper commas/aliases
    COALESCE(prd_cost, 0) AS prd_cost1,
    prd_line,
    prd_start_dt,
    prd_end_dt
FROM
    bronze.crm_prd_info;

SELECT
    prd_id,
    prd_key AS original_prd_key,
    -- Needs this to join with sales-details: substring from the 7th character to end
    SUBSTRING(prd_key FROM 7) AS prd_key,
    prd_nm,
    prd_cost,
    -- Use COALESCE in Postgres instead of ISNULL, and ensure proper commas/aliases
    COALESCE(prd_cost, 0) AS prd_cost1,
    prd_line,
	CASE
		WHEN UPPER(TRIM(prd_line)) = 'M' THEN 'Mountain'
		WHEN UPPER(TRIM(prd_line)) = 'R' THEN 'Road'
		WHEN UPPER(TRIM(prd_line)) = 'T' THEN 'Touring'
		WHEN UPPER(TRIM(prd_line)) = 'S' THEN 'Other Sales'
		ELSE 'N/A'
	END AS prd_line,
    prd_start_dt,
    prd_end_dt
FROM
    bronze.crm_prd_info;

--- Other way
SELECT
	PRD_ID,
	PRD_KEY AS ORIGINAL_PRD_KEY,
	-- Needs this to join with sales-details: substring from the 7th character to end
	SUBSTRING(
		PRD_KEY
		FROM
			7
	) AS PRD_KEY,
	PRD_NM,
	PRD_COST,
	-- Use COALESCE in Postgres instead of ISNULL, and ensure proper commas/aliases
	COALESCE(PRD_COST, 0) AS PRD_COST1,
	PRD_LINE,
	CASE UPPER(TRIM(PRD_LINE))
		WHEN 'M' THEN 'Mountain'
		WHEN 'R' THEN 'Road'
		WHEN 'T' THEN 'Touring'
		WHEN 'S' THEN 'Other Sales'
		ELSE 'N/A'
	END AS PRD_LINE,
	PRD_START_DT,
	-- LEAD returns the next row's prd_start_dt within the same prd_key ordered by prd_start_dt
    LEAD(prd_start_dt) OVER (
        PARTITION BY prd_key
        ORDER BY prd_start_dt
    )-1 AS prd_end_dt
FROM
	BRONZE.CRM_PRD_INFO;
	-- to filter out unmatched data after applying transformation
WHERE
	SUBSTRING(
		PRD_KEY
		FROM
			7
	) IN (
		SELECT
			SLS_PRD_KEY
		FROM
			BRONZE.CRM_SALES_DETAILS
	);

-- Check for unwanted Spaces
-- Expectation: No Results
Select prd_nm
FROM bronze.crm_prd_info
WHERE prd_nm <> TRIM (prd_nm);


-- Check for Nulls or Negative Numbers
-- Expectation: No Results
Select prd_cost
FROM bronze.crm_prd_info
WHERE prd_cost < 0 or prd_cost is null;

-- Data Standardization & Consistency
Select distinct prd_line
FROM bronze.crm_prd_info;

-- Check invalid date orders
SELECT
	*
FROM
	BRONZE.CRM_PRD_INFO
	-- End date must not be earlier than the start date
WHERE
	PRD_END_DT < PRD_start_dt;

-- if this is true, then it must be corrected
-- for complex transformations in SQL, it is better to narrow
-- down to a specific example and brainstorm multiple solutions
-- Each record must have a start date
-- Solution 1, swap the end date and start date
-- Solution 2, derive end date from the start date from a few data records in excel. That means end date = start date fo the next record
-- testing for only two cases
SELECT
    prd_id,
    prd_key,
    prd_nm,
    prd_start_dt,
    prd_end_dt,
    -- LEAD returns the next row's prd_start_dt within the same prd_key ordered by prd_start_dt
    LEAD(prd_start_dt) OVER (
        PARTITION BY prd_key
        ORDER BY prd_start_dt
    )-1 AS prd_end_dt_test
FROM
    bronze.crm_prd_info
WHERE
    prd_key IN ('AC-HE-HL-U509-R', 'AC-HE-HL-U509');

--testing for the whole case
SELECT
    prd_id,
    prd_key,
    prd_nm,
    prd_start_dt,
    -- LEAD returns the next row's prd_start_dt within the same prd_key ordered by prd_start_dt
    LEAD(prd_start_dt) OVER (
        PARTITION BY prd_key
        ORDER BY prd_start_dt
    )-1 AS prd_end_dt
FROM
    bronze.crm_prd_info;

-- FINAL RESULT OF CLEANING PRODUCT INFO AND INSERTING INTO SILVER.CRM_PRD_INFO
-- FRIST CREATE A NEW TABLE CONTAINING THE NEW COLUMNS
DROP TABLE SILVER.CRM_PRD_INFO;
CREATE TABLE SILVER.CRM_PRD_INFO (
	PRD_ID INT,
	CAT_ID CHARACTER VARYING(50),
	PRD_KEY CHARACTER VARYING(50),
	PRD_NM CHARACTER VARYING(50),
	PRD_COST NUMERIC (10,2),
	PRD_LINE CHARACTER VARYING (50),
	PRD_START_DT DATE,
	PRD_END_DT DATE,
	DWH_CREATE_DATE timestamp without time zone DEFAULT CURRENT_TIMESTAMP
);
INSERT INTO SILVER.CRM_PRD_INFO (
	PRD_ID,
	CAT_ID,
	PRD_KEY,
	PRD_NM,
	PRD_COST,
	PRD_LINE,
	PRD_START_DT,
	PRD_END_DT
)
SELECT
	PRD_ID,
	REPLACE(SUBSTRING(PRD_KEY, 1, 5), '-', '_') AS CAT_ID,-- EXRACT CATEGORY ID
-- Needs this to join with sales-details
-- Needs this to join with sales-details: substring from the 7th character to end
	SUBSTRING(
		PRD_KEY
		FROM
			7
	) AS PRD_KEY,-- EXTRACT PRODUCT ID
	PRD_NM,
-- Use COALESCE in Postgres instead of ISNULL, and ensure proper commas/aliases
	COALESCE(PRD_COST, 0) AS PRD_COST, -- TO MAKE NULL ZERO
	CASE UPPER(TRIM(PRD_LINE))
		WHEN 'M' THEN 'Mountain'
		WHEN 'R' THEN 'Road'
		WHEN 'T' THEN 'Touring'
		WHEN 'S' THEN 'Other Sales'
		ELSE 'N/A'
	END AS PRD_LINE,-- MAP PRODUCT LINE CODES TO DESCRIPTIVE VALUES
	PRD_START_DT,
	-- LEAD returns the next row's prd_start_dt within the same prd_key ordered by prd_start_dt
    LEAD(prd_start_dt) OVER (
        PARTITION BY prd_key
        ORDER BY prd_start_dt
    )-1 AS prd_end_dt -- CALCULATE END DATE AS ONE DAY BEFORE THE NEXT START DATE
FROM
	BRONZE.CRM_PRD_INFO;

SELECT * FROM SILVER.CRM_PRD_INFO;

DERIVED COLUMNS AND DATA ENRICHMENT
