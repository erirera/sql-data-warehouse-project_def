-- INSERT CONTENT INTO THE SILVER SCHEMA
INSERT INTO silver.crm_sales_details
(
    sls_ord_num,
    sls_prd_key,
    sls_cust_id,
    sls_order_dt,
    sls_ship_dt,
    sls_due_dt,
    sls_sales,
    sls_quantity,
    sls_price
)
SELECT
	SLS_ORD_NUM,
	SLS_PRD_KEY,
	SLS_CUST_ID,
-- removing invalid data or converting to null in the order dates, shipping date and due date
CASE WHEN SLS_ORDER_DT =0 OR LENGTH(SLS_ORDER_DT::TEXT)<>8 THEN NULL
	ELSE CAST (CAST(SLS_ORDER_DT AS CHARACTER VARYING) AS DATE)
END AS SLS_ORDER_DT,
CASE WHEN SLS_SHIP_DT =0 OR LENGTH(SLS_SHIP_DT::TEXT)<>8 THEN NULL
	ELSE CAST (CAST(SLS_SHIP_DT AS CHARACTER VARYING) AS DATE)
END AS SLS_SHIP_DT,
CASE WHEN SLS_DUE_DT =0 OR LENGTH(SLS_DUE_DT::TEXT)<>8 THEN NULL
	ELSE CAST (CAST(SLS_DUE_DT AS CHARACTER VARYING) AS DATE)
END AS SLS_DUE_DT,
-- Recalculate sales if original value is missing or incorrect
	CASE
		WHEN SLS_SALES IS NULL
		OR SLS_SALES <= 0
		OR SLS_SALES <> SLS_QUANTITY * ABS(SLS_PRICE) THEN SLS_QUANTITY * ABS(SLS_PRICE)
		ELSE SLS_SALES
	END AS SLS_SALES,
	SLS_QUANTITY,
	CASE
		WHEN SLS_PRICE IS NULL
		OR SLS_PRICE <= 0 THEN SLS_SALES / NULLIF(SLS_QUANTITY, 0)
		ELSE SLS_PRICE
	END AS SLS_PRICE -- Derive price if original value is invalid

FROM
	BRONZE.CRM_SALES_DETAILS;

-- THE CLEANED 41 LINES ABOVE CAME FROM THE LINES BELOW COLUMN BY COLUMN CLEANING ---
SELECT
	*
FROM
	BRONZE.CRM_SALES_DETAILS;

-- Check for invalid dates. -- Negative numbers or zeros can't be cast to a date
SELECT
    sls_order_dt
FROM
    bronze.crm_sales_details
where sls_order_dt <= 0;

-- NULLIF() returns NULL if two given values are equal; otherwise, 
-- it returns the first expression.
-- or check for the bounday of the date range
SELECT
	NULLIF(SLS_ORDER_DT, 0) SLS_ORDER_DT
FROM
	BRONZE.CRM_SALES_DETAILS
WHERE
	SLS_ORDER_DT <= 0
	OR LENGTH(SLS_ORDER_DT::TEXT) <> 8
	OR SLS_ORDER_DT > 20500101
	OR SLS_ORDER_DT < 19000101;

SELECT
	NULLIF(SLS_SHIP_DT, 0) SLS_SHIP_DT
FROM
	BRONZE.CRM_SALES_DETAILS
WHERE
	SLS_SHIP_DT <= 0
	OR LENGTH(SLS_SHIP_DT::TEXT) <> 8
	OR SLS_SHIP_DT > 20500101
	OR SLS_SHIP_DT < 19000101;

SELECT
	NULLIF(SLS_DUE_DT, 0) SLS_DUE_DT
FROM
	BRONZE.CRM_SALES_DETAILS
WHERE
	SLS_DUE_DT <= 0
	OR LENGTH(SLS_DUE_DT::TEXT) <> 8
	OR SLS_DUE_DT > 20500101
	OR SLS_DUE_DT < 19000101;

-- ORDER DATE MUST ALWAYS BE EARLIER THAN THE SHIPPING DATE OR DUE DATE
-- CHECK FOR INVALID DATES
SELECT * FROM BRONZE.CRM_SALES_DETAILS
WHERE SLS_ORDER_DT> SLS_SHIP_DT OR SLS_ORDER_DT > SLS_DUE_DT;

-- ORDER DATE MUST ALWAYS BE EARLIER THAN THE SHIPPING DATE OR DUE DATE
-- NEGATIVE, ZEROS, NULLS ARE NOT ALLOWED WITH SALES = QUANTITY * PRICE
-- CHECK FOR THESE
SELECT DISTINCT
	SLS_SALES AS OLD_SLS_SALES,
	SLS_QUANTITY,
	SLS_PRICE AS OLD_SLS_PRICE,
	CASE
		WHEN SLS_SALES IS NULL
		OR SLS_SALES <= 0
		OR SLS_SALES <> SLS_QUANTITY * ABS(SLS_PRICE) THEN SLS_QUANTITY * ABS(SLS_PRICE)
		ELSE SLS_SALES
	END AS SLS_SALES,
	CASE
		WHEN SLS_PRICE IS NULL
		OR SLS_PRICE <= 0 THEN SLS_SALES / NULLIF(SLS_QUANTITY, 0)
		ELSE SLS_PRICE
	END AS SLS_PRICE
FROM
	BRONZE.CRM_SALES_DETAILS
WHERE
	SLS_SALES <> SLS_QUANTITY * SLS_PRICE
	OR SLS_SALES IS NULL
	OR SLS_QUANTITY IS NULL
	OR SLS_PRICE IS NULL
	OR SLS_SALES <= 0
	OR SLS_QUANTITY <= 0
	OR SLS_PRICE <= 0
ORDER BY
	SLS_SALES,
	SLS_QUANTITY,
	SLS_PRICE;
-- TALK TO THE EXPERTS ABOUT THESE IF QUERY IS POSITIVE
-- DATA ISSUES COULD BE FIXED DIRECT IN THE SOURCE SYSTEM
-- DATA ISSUES COULD BE FIXED IN THE DATA WAREHOUSE
-- MAY HAVE TO DEVELOP RULES SUCH AS 
-- IF SALES IS NEGATIVE, ZERO, OR NULL, DERIVE IT USING QUANTITY AND PRICE
-- IF PRICE IS ZERO OR NULL, CALCULATE IT USING SALES AND QUANTITY
-- IF PRICE IS NEGATIVE, CONVERT IT TO A POSITIVE VALUE

SELECT
	SLS_ORD_NUM,
	SLS_PRD_KEY,
	SLS_CUST_ID,
	cast (SLS_ORDER_DT as Date) As SLS_ORDER_DT,
	SLS_SHIP_DT,
	SLS_DUE_DT,
	SLS_SALES,
	SLS_QUANTITY,
	SLS_PRICE
FROM
	BRONZE.CRM_SALES_DETAILS
WHERE SLS_ORD_NUM <>TRIM(SLS_ORD_NUM);

SELECT
	SLS_ORD_NUM,
	SLS_PRD_KEY,
	SLS_CUST_ID,
	cast (SLS_ORDER_DT as Date) As SLS_ORDER_DT,
	SLS_SHIP_DT,
	SLS_DUE_DT,
	SLS_SALES,
	SLS_QUANTITY,
	SLS_PRICE
FROM
	BRONZE.CRM_SALES_DETAILS
WHERE SLS_PRD_KEY NOT IN (SELECT PRD_KEY FROM SILVER.CRM_PRD_INFO);

SELECT
	SLS_ORD_NUM,
	SLS_PRD_KEY,
	SLS_CUST_ID,
	cast (SLS_ORDER_DT as Date) As SLS_ORDER_DT,
	SLS_SHIP_DT,
	SLS_DUE_DT,
	SLS_SALES,
	SLS_QUANTITY,
	SLS_PRICE
FROM
	BRONZE.CRM_SALES_DETAILS
WHERE SLS_PRD_KEY NOT IN (SELECT PRD_KEY FROM SILVER.CRM_PRD_INFO);
