INSERT INTO SILVER.ERP_CUST_AZ12 (
CID, BDATE, GEN
)
SELECT
	CASE
		WHEN CID LIKE 'NAS%' THEN SUBSTRING(
			CID
			FROM
				4
		) -- removes NAS prefix if present
		ELSE CID
	END AS CID, 
-- set future bdate to null
	CASE WHEN BDATE > CURRENT_DATE THEN NULL
		ELSE BDATE
	END AS BDATE,
	CASE
		WHEN UPPER(TRIM(GEN)) IN ('F', 'FEMALE') THEN 'Female'
		WHEN UPPER(TRIM(GEN)) IN ('M', 'MALE') THEN 'Male'
		ELSE 'Null'
	END AS GEN -- normal gender values and handle unknown cases
FROM
	BRONZE.ERP_CUST_AZ12;

-- the cleaned sql query above was derived from the data transformation below
-- Checking for unmatched data in the silver schema customer info and the bronze_erp customer info IDS
SELECT
	CASE
		WHEN CID LIKE 'NAS%' THEN SUBSTRING(
			CID
			FROM
				4
		)
		ELSE CID
	END AS CID,
	BDATE,
-- IDENTIFY OUT OF RANGE DATES
	CASE WHEN BDATE > CURRENT_DATE THEN NULL
		ELSE BDATE
	END AS BDATE,
-- DATA STANDARDIZATION & CONSISTENCY
	GEN
FROM
	BRONZE.ERP_CUST_AZ12;

Check the gender column
select distinct gen
from bronze.erp_cust_az12;


SELECT
	CID,
	CASE
		WHEN CID LIKE 'NAS%' THEN SUBSTRING(
			CID
			FROM
				4
		)
		ELSE CID
	END AS CID,
	BDATE,
	GEN
	FROM BRONZE.ERP_CUST_AZ12;

-- add the below query to the one above to check unmatched data between the silver schema customer info and the bronze_erp customer info
WHERE CASE
		WHEN CID LIKE 'NAS%' THEN SUBSTRING(
			CID
			FROM
				4
		)
		ELSE CID
	END NOT IN (
		SELECT DISTINCT
			CST_KEY
		FROM
			SILVER.CRM_CUST_INFO
	);

-- check for very old and future customers 
SELECT DISTINCT
	BDATE
FROM
	BRONZE.ERP_CUST_AZ12
WHERE
	BDATE < '1924-01-01'
	OR BDATE > CURRENT_DATE;
