-- FINAL RESULT OF CLEANING PRODUCT INFO AND INSERTING INTO SILVER.CRM_PRD_INFO
-- FRIST CREATE A NEW TABLE CONTAINING THE NEW COLUMNS
DROP TABLE SILVER.CRM_PRD_INFO;
CREATE TABLE SILVER.CRM_PRD_INFO (
	PRD_ID INT,
	CAT_ID CHARACTER VARYING(50),
	PRD_KEY CHARACTER VARYING(50),
	PRD_NM CHARACTER VARYING(50),
	PRD_COST NUMERIC (10,2),
	PRD_LINE CHARACTER VARYING (50),
	PRD_START_DT DATE,
	PRD_END_DT DATE,
	DWH_CREATE_DATE timestamp without time zone DEFAULT CURRENT_TIMESTAMP
);
INSERT INTO SILVER.CRM_PRD_INFO (
	PRD_ID,
	CAT_ID,
	PRD_KEY,
	PRD_NM,
	PRD_COST,
	PRD_LINE,
	PRD_START_DT,
	PRD_END_DT
)
SELECT
	PRD_ID,
	REPLACE(SUBSTRING(PRD_KEY, 1, 5), '-', '_') AS CAT_ID,-- EXRACT CATEGORY ID
-- Needs this to join with sales-details
-- Needs this to join with sales-details: substring from the 7th character to end
	SUBSTRING(
		PRD_KEY
		FROM
			7
	) AS PRD_KEY,-- EXTRACT PRODUCT ID
	PRD_NM,
-- Use COALESCE in Postgres instead of ISNULL, and ensure proper commas/aliases
	COALESCE(PRD_COST, 0) AS PRD_COST, -- TO MAKE NULL ZERO
	CASE UPPER(TRIM(PRD_LINE))
		WHEN 'M' THEN 'Mountain'
		WHEN 'R' THEN 'Road'
		WHEN 'T' THEN 'Touring'
		WHEN 'S' THEN 'Other Sales'
		ELSE 'N/A'
	END AS PRD_LINE,-- MAP PRODUCT LINE CODES TO DESCRIPTIVE VALUES
	PRD_START_DT,
	-- LEAD returns the next row's prd_start_dt within the same prd_key ordered by prd_start_dt
    LEAD(prd_start_dt) OVER (
        PARTITION BY prd_key
        ORDER BY prd_start_dt
    )-1 AS prd_end_dt -- CALCULATE END DATE AS ONE DAY BEFORE THE NEXT START DATE
FROM
	BRONZE.CRM_PRD_INFO;

--- THE 52 LINES ABOVE CAME FROM THE DATA TRANSFORMATIONS BELOW


