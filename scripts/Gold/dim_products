CREATE VIEW GOLD.DIM_PRODUCTS AS -- CREATE PRODUCT VIEW IN GOLD SCHEMA
SELECT
ROW_NUMBER() OVER (
	ORDER BY
		PN.PRD_START_DT,
		PN.PRD_KEY
) AS PRODUCT_KEY, -- CREATE SURROGATE KEY
	PN.PRD_ID AS PRODUCT_ID,
	PN.PRD_KEY AS PRODUCT_NUMBER,
	PN.PRD_NM AS PRODUCT_NAME,
	PN.CAT_ID AS CATEGORY_ID,
	PC.CAT AS CATEGORY,
	PC.SUBCAT AS SUBCATEGORY,
	PC.MAINTENANCE,
	PN.PRD_COST AS COST,
	PN.PRD_LINE AS PRODUCT_LINE,
	PN.PRD_START_DT AS START_DATE
FROM
	SILVER.CRM_PRD_INFO PN
	LEFT JOIN SILVER.ERP_PX_CAT_G1V2 PC ON PN.CAT_ID = PC.ID
WHERE
	PRD_END_DT IS NULL; -- filters out all historical data

--------------------------
SELECT PRD_KEY, COUNT(*) FROM -- check for duplicates in PRODUCT KEY
(SELECT 
pn.prd_id,
pn.cat_id,
pn.prd_key,
pn.prd_nm,
pn.prd_cost,
pn.prd_line,
pn.prd_start_dt,
pn.prd_end_dt,
pc.cat,
pc.subcat,
pc.maintenance
FROM
SILVER.CRM_PRD_INFO PN
LEFT JOIN SILVER.ERP_PX_CAT_G1V2 PC ON PN.CAT_ID = PC.ID
WHERE PRD_END_DT IS NULL) T -- Filter out historical data. Limit to the current data
GROUP BY PRD_KEY HAVING COUNT(*)>1; 
