CREATE VIEW GOLD.DIM_CUSTOMERS AS -- CREATE A VIEW IN GOLD SCHEMA
SELECT 
			ROW_NUMBER()OVER(ORDER BY CST_ID) AS CUSTOMER_KEY, -- CREATING SURROGATE KEY
			CI.CST_ID AS CUSTOMER_ID, -- USING FRIENDLY NAMES IN THE GOLD SCHEMA
			CI.CST_KEY AS CUSTOMER_NUMBER,
			CI.CST_FIRSTNAME AS FIRST_NAME,
			CI.CST_LASTNAME AS LAST_NAME,
			LA.CNTRY AS COUNTRY,
			CI.CST_MARITAL_STATUS AS MARITAL_STATUS,
			CASE WHEN CI.CST_GNDR <> 'N/A' THEN CI.CST_GNDR -- CRM IS THE MASTER TABLE FOR GENDER INFO
			ELSE COALESCE(CA.GEN, 'N/A')
			END AS GENDER,
			CA.BDATE AS BIRTH_DATE,
			CI.CST_CREATE_DATE AS CREATE_DATE
		FROM
			SILVER.CRM_CUST_INFO CI
			LEFT JOIN SILVER.ERP_CUST_AZ12 CA ON CI.CST_KEY = CA.CID
			LEFT JOIN SILVER.ERP_LOC_A101 LA ON CI.CST_KEY = LA.CID;

SELECT -- check for duplicates in customer ID
	CST_ID,
	COUNT(*)
FROM -- to join three tables
	(
		SELECT
			CI.CST_ID,
			CI.CST_KEY,
			CI.CST_FIRSTNAME,
			CI.CST_LASTNAME,
			CI.CST_MARITAL_STATUS,
			CASE WHEN CI.CST_GNDR <> 'N/A' THEN CI.CST_GNDR -- CRM IS THE MASTER TABLE FOR GENDER INFO
			ELSE COALESCE(CA.GEN, 'N/A')
			END AS NEW_GEN,
			CI.CST_CREATE_DATE,
			CA.BDATE,
			LA.CNTRY
		FROM
			SILVER.CRM_CUST_INFO CI
			LEFT JOIN SILVER.ERP_CUST_AZ12 CA ON CI.CST_KEY = CA.CID
			LEFT JOIN SILVER.ERP_LOC_A101 LA ON CI.CST_KEY = LA.CID
	) T
GROUP BY
	CST_ID
HAVING
	COUNT(*) > 1;

SELECT DISTINCT-- Check for consistency in the gender columns from the two tables
			CI.CST_GNDR,
			CA.GEN,
			CASE WHEN CI.CST_GNDR <> 'N/A' THEN CI.CST_GNDR -- CRM IS THE MASTER TABLE FOR GENDER INFO
			ELSE COALESCE(CA.GEN, 'N/A')
			END AS NEW_GEN
		FROM
			SILVER.CRM_CUST_INFO CI
			LEFT JOIN SILVER.ERP_CUST_AZ12 CA ON CI.CST_KEY = CA.CID
			LEFT JOIN SILVER.ERP_LOC_A101 LA ON CI.CST_KEY = LA.CID;
