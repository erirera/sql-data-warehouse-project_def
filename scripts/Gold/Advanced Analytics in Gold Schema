Change Over Time Analysis
===============================================================================
Purpose:
    - To track trends, growth, and changes in key metrics over time.
    - For time-series analysis and identifying seasonality.
    - To measure growth or decline over specific periods.

SQL Functions Used:
    - Date Functions: EXTRACT (YEAR FROM...), (EXTRACT MONTH FROM ....), DATE_TRUNC(), TO_CHAR()
    - Aggregate Functions: SUM(), COUNT(), AVG()
===============================================================================
*/

-- Analyse sales performance over time
-- Quick Date Functions in Postgres
SELECT
  EXTRACT(YEAR FROM order_date)::int AS order_year,
  EXTRACT(MONTH FROM order_date)::int AS order_month,
  SUM(sales) AS total_sales,
  COUNT(DISTINCT customer_key) AS total_customers,
  SUM(quantity) AS total_quantity
FROM gold.fact_sales
WHERE order_date IS NOT NULL
GROUP BY EXTRACT(YEAR FROM order_date)::int, EXTRACT(MONTH FROM order_date)::int
ORDER BY EXTRACT(YEAR FROM order_date)::int, EXTRACT(MONTH FROM order_date)::int;

-- DATETRUNC() in Postgres
SELECT
  date_trunc('month', order_date) AS order_month,
  SUM(sales) AS total_sales,
  COUNT(DISTINCT customer_key) AS total_customers,
  SUM(quantity) AS total_quantity
FROM gold.fact_sales
WHERE order_date IS NOT NULL
GROUP BY date_trunc('month', order_date)
ORDER BY date_trunc('month', order_date);

-- TO_CHAR()
SELECT
  to_char(date_trunc('month', order_date), 'YYYY-MON') AS order_date,
  SUM(sales) AS total_sales,
  COUNT(DISTINCT customer_key) AS total_customers,
  SUM(quantity) AS total_quantity
FROM gold.fact_sales
WHERE order_date IS NOT NULL
GROUP BY date_trunc('month', order_date)
ORDER BY date_trunc('month', order_date);

/*
===============================================================================
Cumulative Analysis
===============================================================================
Purpose:
    - To calculate running totals or moving averages for key metrics.
    - To track performance over time cumulatively.
    - Useful for growth analysis or identifying long-term trends.

SQL Functions Used:
    - Window Functions: SUM() OVER(), AVG() OVER()
===============================================================================
*/

-- Calculate the total sales per month 
-- and the running total of sales over time 
-- calendar year (start timestamp), formatted totals and average
SELECT
	year_start,
	total_sales,
	SUM(total_sales) OVER (ORDER BY year_start) AS running_total_sales,
	AVG(avg_price) OVER (ORDER BY year_start) AS moving_average_price
FROM
(
    SELECT
  date_trunc('year', order_date)      AS year_start,
  SUM(sales)::numeric(18,2)           AS total_sales,
  ROUND(AVG(price)::numeric, 2)       AS avg_price
FROM gold.fact_sales
WHERE order_date IS NOT NULL
GROUP BY 1
ORDER BY 1
) t

-- calendar month (start timestamp), formatted totals and average
SELECT
	month_start,
	total_sales,
	SUM(total_sales) OVER (ORDER BY month_start) AS running_total_sales,
	AVG(avg_price) OVER (ORDER BY month_start) AS moving_average_price
FROM
(
    SELECT
  date_trunc('month', order_date)      AS month_start,
  SUM(sales)::numeric(18,2)           AS total_sales,
  ROUND(AVG(price)::numeric, 2)       AS avg_price
FROM gold.fact_sales
WHERE order_date IS NOT NULL
GROUP BY 1
ORDER BY 1
) t
-- Alternative year as integer (easier for joins/labels)
SELECT
	year,
	total_sales,
	SUM(total_sales) OVER (ORDER BY year) AS running_total_sales,
	AVG(avg_price) OVER (ORDER BY year) AS moving_average_price
FROM
(
    SELECT
  EXTRACT(YEAR FROM order_date)::int AS year,
  SUM(sales)::numeric(18,2)           AS total_sales,
  ROUND(AVG(price)::numeric, 3)       AS avg_price
FROM gold.fact_sales
WHERE order_date IS NOT NULL
GROUP BY 1
ORDER BY 1
) t

-- Alternative month as integer (easier for joins/labels)
SELECT
	month,
	total_sales,
	SUM(total_sales) OVER (ORDER BY month) AS running_total_sales,
	AVG(avg_price) OVER (ORDER BY month) AS moving_average_price
FROM
(
    SELECT
  EXTRACT(month FROM order_date)::int AS month,
  SUM(sales)::numeric(18,2)           AS total_sales,
  ROUND(AVG(price)::numeric, 2)       AS avg_price
FROM gold.fact_sales
WHERE order_date IS NOT NULL
GROUP BY 1
ORDER BY 1
) t

/*
===============================================================================
Performance Analysis (Year-over-Year, Month-over-Month)
===============================================================================
Purpose:
    - To measure the performance of products, customers, or regions over time.
    - For benchmarking and identifying high-performing entities.
    - To track yearly trends and growth.

SQL Functions Used:
    - LAG(): Accesses data from previous rows.
    - AVG() OVER(): Computes average values within partitions.
    - CASE: Defines conditional logic for trend analysis.
	- EXTRACT(YEAR FROM): Extracts year from order_date
===============================================================================
*/

/* Analyze the yearly performance of products by comparing their sales 
to both the average sales performance of the product and the previous year's sales */
WITH yearly_product_sales AS (
    SELECT
        EXTRACT(YEAR FROM f.order_date)::int AS order_year,
        p.product_name,
        SUM(f.sales) AS current_sales
    FROM gold.fact_sales f
    LEFT JOIN gold.dim_products p
        ON f.product_key = p.product_key
    WHERE f.order_date IS NOT NULL
    GROUP BY 
        EXTRACT(YEAR FROM f.order_date),
        p.product_name
),

sales_metrics AS (
    SELECT
        order_year,
        product_name,
        current_sales,
        AVG(current_sales) OVER (PARTITION BY product_name) AS avg_sales,
        LAG(current_sales) OVER (PARTITION BY product_name ORDER BY order_year) AS py_sales
    FROM yearly_product_sales
)

SELECT
    order_year,
    product_name,
    current_sales,
    avg_sales,
    current_sales - avg_sales AS diff_avg,
    -- percent difference vs average; NULL if avg_sales is 0 or NULL
    ROUND(100.0 * (current_sales - avg_sales) / NULLIF(avg_sales, 0), 2) AS pct_change_vs_avg,
    CASE 
        WHEN current_sales > avg_sales THEN 'Above Avg'
        WHEN current_sales < avg_sales THEN 'Below Avg'
        ELSE 'Avg'
    END AS avg_change,
    -- Year-over-Year Analysis
    py_sales,
    current_sales - py_sales AS diff_py,
    -- YoY percent change; NULL if py_sales is 0 or NULL
    ROUND(100.0 * (current_sales - py_sales) / NULLIF(py_sales, 0), 2) AS pct_change_py,
    CASE 
        WHEN py_sales IS NULL THEN 'No Prior Year'
        WHEN current_sales > py_sales THEN 'Increase'
        WHEN current_sales < py_sales THEN 'Decrease'
        ELSE 'No Change'
    END AS py_change
FROM sales_metrics
ORDER BY product_name, order_year;
